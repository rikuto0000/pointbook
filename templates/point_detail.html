<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ point.title }} | VALORANT Pointbook</title>

  <!-- ✅ PWA対応 -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#ff4655">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Pointbook">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

  <!-- ✅ Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(reg => console.log("✅ Service Worker registered"))
        .catch(err => console.error("❌ Service Worker error:", err));
    }
  </script>

  <!-- ✅ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ Rajdhani Font -->
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- ✅ Modern Styles -->
  <link rel="stylesheet" href="/static/css/modern.css">

  <!-- ✅ Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Fallback styles -->
  {% include 'base_styles.html' %}
  
  <!-- User State -->
  <script>
    window.currentUser = {{ user|tojson if user else 'null' }};
    window.setupId = "{{ point.id }}";
    window.isLiked = {{ 'true' if is_liked else 'false' }};
    window.isBookmarked = {{ 'true' if is_bookmarked else 'false' }};
  </script>
</head>

<body>
  <!-- Animated Background Particles -->
  <div class="particles">
    {% for i in range(6) %}
    <div class="particle" style="left: {{ (i * 15 + 10) }}%; animation-delay: {{ i * 0.8 }}s;"></div>
    {% endfor %}
  </div>

  <!-- Navigation -->
  <nav class="p-4 flex justify-between items-center" style="animation: slideInLeft 0.6s ease-out;">
    <div class="flex items-center gap-4">
      <button onclick="goBack()" class="inline-flex items-center gap-2 text-gray-300 hover:text-white transition-colors duration-300">
        <i class="fas fa-arrow-left"></i>
        <span>戻る</span>
      </button>
      <a href="/" class="inline-flex items-center gap-2 text-gray-300 hover:text-white transition-colors duration-300">
        <i class="fas fa-home"></i>
        <span>ホーム</span>
      </a>
    </div>
    
    <!-- User Info -->
    <div class="flex items-center gap-4">
      {% if user %}
        <a href="/profile" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors" style="pointer-events: auto; z-index: 1000;">
          <img src="{{ user.avatar_url or 'https://ui-avatars.com/api/?name=' + user.username + '&background=ff4655&color=fff' }}" 
               alt="{{ user.username }}" 
               class="w-8 h-8 rounded-full">
          <span class="hidden sm:inline">{{ user.username }}</span>
        </a>
        <a href="/logout" class="text-gray-400 hover:text-white transition-colors">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      {% else %}
        <a href="/login" class="btn-primary text-sm py-2 px-4">
          <i class="fas fa-sign-in-alt"></i>
          <span class="hidden sm:inline">ログイン</span>
        </a>
      {% endif %}
    </div>
  </nav>

  <!-- Header -->
  <header class="glass rounded-2xl mx-4 mb-8 p-6 text-center" style="animation: fadeInUp 0.8s ease-out;">
    <h1 class="text-3xl sm:text-4xl font-bold text-glow mb-4">
      {{ point.title }}
    </h1>
    <p class="text-lg text-gray-300">{{ point.description }}</p>
    
    <!-- Stats -->
    <div class="flex items-center justify-center gap-6 mt-4 text-sm">
      <div class="flex items-center gap-2">
        <i class="fas fa-heart text-red-400"></i>
        <span id="likes-count">{{ point.likes_count or 0 }}</span> いいね
      </div>
      <div class="flex items-center gap-2">
        <i class="fas fa-map text-blue-400"></i>
        <span>{{ point.map }}</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="fas fa-user text-purple-400"></i>
        <span>{{ point.agent }}</span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 justify-center mt-6">
      {% if user %}
        <button id="like-btn" onclick="toggleLike()" 
                class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105
                       {% if is_liked %}bg-gradient-to-r from-red-500 to-pink-600 text-white{% else %}bg-gray-700 hover:bg-gray-600 text-gray-300{% endif %}">
          <i class="{% if is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
          <span>{% if is_liked %}いいね済み{% else %}いいね{% endif %}</span>
        </button>
        
        <button id="bookmark-btn" onclick="toggleBookmark()" 
                class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105
                       {% if is_bookmarked %}bg-gradient-to-r from-yellow-500 to-orange-600 text-white{% else %}bg-gray-700 hover:bg-gray-600 text-gray-300{% endif %}">
          <i class="{% if is_bookmarked %}fas{% else %}far{% endif %} fa-bookmark"></i>
          <span>{% if is_bookmarked %}保存済み{% else %}保存{% endif %}</span>
        </button>
      {% else %}
        <a href="/login?next={{ request.url }}" 
           class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg font-semibold transition-all duration-300">
          <i class="far fa-heart"></i>
          <span>ログインしていいね</span>
        </a>
        
        <a href="/login?next={{ request.url }}" 
           class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg font-semibold transition-all duration-300">
          <i class="far fa-bookmark"></i>
          <span>ログインして保存</span>
        </a>
      {% endif %}
      
      <button onclick="sharePoint()" 
              class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-share"></i>
        <span>共有</span>
      </button>
    </div>
  </header>

  <!-- Images Grid -->
  <main class="container mx-auto px-4 pb-8">
    <div class="max-w-4xl mx-auto space-y-8">

      <!-- Stand Position -->
      <article class="card" style="animation: fadeInUp 0.8s ease-out 0.1s both;">
        <div class="p-6 pb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
              <i class="fas fa-map-marker-alt text-white text-lg"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">立ち位置</h2>
              <p class="text-gray-300 text-sm">この場所に立ってください</p>
            </div>
          </div>
        </div>
        <div class="relative overflow-hidden cursor-pointer" onclick="openLightbox('{{ point.stand_image }}', '立ち位置')">
          <img src="{{ point.stand_image }}" 
               alt="立ち位置" 
               class="w-full h-64 sm:h-80 object-cover enhanced-image hover:scale-105 transition-transform duration-300"
               loading="lazy"
               onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-64 bg-gray-700 text-gray-400\'><i class=\'fas fa-image text-4xl\'></i></div>'" />
        </div>
      </article>

      <!-- Aim Point -->
      <article class="card" style="animation: fadeInUp 0.8s ease-out 0.2s both;">
        <div class="p-6 pb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center">
              <i class="fas fa-crosshairs text-white text-lg"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">エイムポイント</h2>
              <p class="text-gray-300 text-sm">この位置を狙ってください</p>
            </div>
          </div>
        </div>
        <div class="relative overflow-hidden cursor-pointer" onclick="openLightbox('{{ point.point_image }}', 'エイムポイント')">
          <img src="{{ point.point_image }}" 
               alt="エイムポイント" 
               class="w-full h-64 sm:h-80 object-cover enhanced-image hover:scale-105 transition-transform duration-300"
               loading="lazy"
               onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-64 bg-gray-700 text-gray-400\'><i class=\'fas fa-image text-4xl\'></i></div>'" />
        </div>
      </article>

      <!-- Extra Info -->
      <article class="card" style="animation: fadeInUp 0.8s ease-out 0.3s both;">
        <div class="p-6 pb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center">
              <i class="fas fa-info-circle text-white text-lg"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">着弾位置</h2>
              <p class="text-gray-300 text-sm">スキルの効果範囲</p>
            </div>
          </div>
        </div>
        <div class="relative overflow-hidden rounded-b-2xl cursor-pointer" onclick="openLightbox('{{ point.extra_image }}', '着弾位置')">
          <img src="{{ point.extra_image }}" 
               alt="着弾位置" 
               class="w-full h-64 sm:h-80 object-cover enhanced-image hover:scale-105 transition-transform duration-300"
               loading="lazy"
               onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-64 bg-gray-700 text-gray-400\'><i class=\'fas fa-image text-4xl\'></i></div>'" />
        </div>
      </article>

      <!-- Delete Button (if owner) -->
      {% if user and (user.id == point.user_id or user.id == SYSTEM_USER_ID) %}
      <div class="flex justify-center" style="animation: fadeInUp 0.8s ease-out 0.4s both;">
        <form action="/delete/{{ point.id }}" method="POST" onsubmit="return confirm('この定点を削除しますか？');">
          <button type="submit" class="inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-500 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
            <i class="fas fa-trash"></i>
            <span>削除</span>
          </button>
        </form>
      </div>
      {% endif %}

    </div>
  </main>

  <!-- Enhanced FAB -->
  <a href="/add" class="fab group" title="新しい定点を追加">
    <i class="fas fa-plus transition-transform duration-300 group-hover:rotate-90"></i>
  </a>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-50" onclick="closeLightbox(event)">
    <div class="relative max-w-6xl max-h-screen p-4">
      <img id="lightbox-img" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
      <button onclick="closeLightbox()" class="absolute top-4 right-4 w-12 h-12 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white">
        <i class="fas fa-times text-xl"></i>
      </button>
      <div id="lightbox-caption" class="absolute bottom-4 left-4 text-white text-lg font-bold"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform translate-y-full">
    <div class="flex items-center gap-3">
      <i id="toast-icon" class="fas fa-check text-green-400"></i>
      <span id="toast-message">メッセージ</span>
    </div>
  </div>

  <script>
    // Navigation functionality
    function goBack() {
      // Simple and reliable back navigation
      if (document.referrer && document.referrer !== window.location.href) {
        // If we came from another page, go back
        window.history.back();
        
        // Fallback in case back doesn't work
        setTimeout(() => {
          if (window.location.href === window.location.href) {
            window.location.href = '/';
          }
        }, 300);
      } else {
        // If no referrer, go to home
        window.location.href = '/';
      }
    }

    // Like/Bookmark functionality
    async function toggleLike() {
      if (!window.currentUser) {
        window.location.href = '/login?next=' + encodeURIComponent(window.location.href);
        return;
      }

      try {
        const response = await fetch(`/api/like/${window.setupId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          const btn = document.getElementById('like-btn');
          const icon = btn.querySelector('i');
          const text = btn.querySelector('span');
          const countEl = document.getElementById('likes-count');
          
          if (data.liked) {
            btn.className = 'inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-red-500 to-pink-600 text-white';
            icon.className = 'fas fa-heart';
            text.textContent = 'いいね済み';
            countEl.textContent = parseInt(countEl.textContent) + 1;
            showToast('いいねしました！', 'heart', 'text-red-400');
          } else {
            btn.className = 'inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 bg-gray-700 hover:bg-gray-600 text-gray-300';
            icon.className = 'far fa-heart';
            text.textContent = 'いいね';
            countEl.textContent = Math.max(0, parseInt(countEl.textContent) - 1);
            showToast('いいねを解除しました', 'heart-broken', 'text-gray-400');
          }
          
          window.isLiked = data.liked;
        } else {
          showToast('エラーが発生しました', 'exclamation-triangle', 'text-red-400');
        }
      } catch (error) {
        console.error('Like error:', error);
        showToast('エラーが発生しました', 'exclamation-triangle', 'text-red-400');
      }
    }

    async function toggleBookmark() {
      if (!window.currentUser) {
        window.location.href = '/login?next=' + encodeURIComponent(window.location.href);
        return;
      }

      try {
        const response = await fetch(`/api/bookmark/${window.setupId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          const btn = document.getElementById('bookmark-btn');
          const icon = btn.querySelector('i');
          const text = btn.querySelector('span');
          
          if (data.bookmarked) {
            btn.className = 'inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 bg-gradient-to-r from-yellow-500 to-orange-600 text-white';
            icon.className = 'fas fa-bookmark';
            text.textContent = '保存済み';
            showToast('保存しました！', 'bookmark', 'text-yellow-400');
          } else {
            btn.className = 'inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 bg-gray-700 hover:bg-gray-600 text-gray-300';
            icon.className = 'far fa-bookmark';
            text.textContent = '保存';
            showToast('保存を解除しました', 'bookmark', 'text-gray-400');
          }
          
          window.isBookmarked = data.bookmarked;
        } else {
          showToast('エラーが発生しました', 'exclamation-triangle', 'text-red-400');
        }
      } catch (error) {
        console.error('Bookmark error:', error);
        showToast('エラーが発生しました', 'exclamation-triangle', 'text-red-400');
      }
    }

    function sharePoint() {
      try {
        if (navigator.share) {
          navigator.share({
            title: '{{ point.title }}',
            text: '{{ point.description }}',
            url: window.location.href
          });
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(window.location.href).then(() => {
            showToast('URLをコピーしました！', 'copy', 'text-blue-400');
          });
        }
      } catch (err) {
        console.error('Share error:', err);
        showToast('共有に失敗しました', 'exclamation-triangle', 'text-red-400');
      }
    }

    // Lightbox functions
    function openLightbox(src, caption) {
      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img');
      const captionEl = document.getElementById('lightbox-caption');
      
      img.src = src;
      img.alt = caption;
      captionEl.textContent = caption;
      lightbox.classList.remove('hidden');
      lightbox.classList.add('flex');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox(event) {
      if (event && event.target !== event.currentTarget && !event.target.classList.contains('fa-times')) {
        return;
      }
      
      const lightbox = document.getElementById('lightbox');
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      
      // Restore body scroll
      document.body.style.overflow = '';
    }

    // Toast notification
    function showToast(message, iconClass = 'check', iconColor = 'text-green-400') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const messageEl = document.getElementById('toast-message');
      
      icon.className = `fas fa-${iconClass} ${iconColor}`;
      messageEl.textContent = message;
      
      toast.classList.remove('hidden', 'translate-y-full');
      toast.classList.add('translate-y-0');
      
      setTimeout(() => {
        toast.classList.add('translate-y-full');
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 300);
      }, 3000);
    }

    // Parallax effect
    document.addEventListener('mousemove', function(e) {
      try {
        const particles = document.querySelectorAll('.particle');
        if (particles.length > 0) {
          const mouseX = e.clientX / window.innerWidth;
          const mouseY = e.clientY / window.innerHeight;

          particles.forEach((particle, index) => {
            const speed = (index + 1) * 0.3;
            const x = mouseX * speed * 15;
            const y = mouseY * speed * 15;
            if (particle && particle.style) {
              particle.style.transform = `translateX(${x}px) translateY(${y}px)`;
            }
          });
        }
      } catch (err) {
        console.warn('Parallax error:', err);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeLightbox();
      }
      if (e.key === 'l' && e.ctrlKey) {
        e.preventDefault();
        toggleLike();
      }
      if (e.key === 'b' && e.ctrlKey) {
        e.preventDefault();
        toggleBookmark();
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>定点一覧 | VALORANT Pointbook</title>

  <!-- ✅ PWA対応 -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#ff4655">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Pointbook">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

  <!-- ✅ Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(reg => console.log("✅ Service Worker registered"))
        .catch(err => console.error("❌ Service Worker error:", err));
    }
  </script>

  <!-- ✅ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ Rajdhani Font -->
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- ✅ Modern Styles -->
  <link rel="stylesheet" href="/static/css/modern.css">

  <!-- ✅ Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <!-- Animated Background Particles -->
  <div class="particles">
    {% for i in range(8) %}
    <div class="particle" style="left: {{ (i * 12 + 10) }}%; animation-delay: {{ i * 0.7 }}s;"></div>
    {% endfor %}
  </div>

  <!-- Navigation -->
  <nav class="p-4" style="animation: slideInLeft 0.6s ease-out;">
    {% if role %}
      <a href="/map/{{ map_id }}/side/{{ side }}/role/{{ role }}" class="inline-flex items-center gap-2 text-gray-300 hover:text-white transition-colors duration-300">
        <i class="fas fa-arrow-left"></i>
        <span>エージェント選択に戻る</span>
      </a>
    {% else %}
      <a href="/map/{{ map_id }}/side/{{ side }}" class="inline-flex items-center gap-2 text-gray-300 hover:text-white transition-colors duration-300">
        <i class="fas fa-arrow-left"></i>
        <span>サイド選択に戻る</span>
      </a>
    {% endif %}
  </nav>

  <!-- Header -->
  <header class="glass rounded-2xl mx-4 mb-8 p-6 text-center" style="animation: fadeInUp 0.8s ease-out;">
    <div class="flex items-center justify-center gap-4 mb-4">
      <i class="fas fa-crosshairs text-3xl text-glow"></i>
      <h1 class="text-3xl sm:text-4xl font-bold text-glow tracking-wide">
        {{ agent_id | title }} 定点一覧
      </h1>
    </div>
    <p class="text-lg text-gray-300 font-medium">
      選択したエージェントのラインナップ・定点を確認できます
    </p>
    
    <!-- Stats -->
    <div class="flex items-center justify-center gap-6 mt-4 text-sm">
      <div class="flex items-center gap-2">
        <i class="fas fa-map-marker-alt text-red-400"></i>
        <span>{{ points|length }} 個の定点</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="fas fa-user text-blue-400"></i>
        <span>{{ agent_id | title }}</span>
      </div>
    </div>
  </header>

  <!-- Points Grid -->
  <main class="container mx-auto px-4 pb-8">
    {% if points %}
      <div class="grid-container grid-points max-w-7xl mx-auto">
        {% for point in points %}
          <article class="card group relative" style="animation: fadeInUp 0.8s ease-out {{ loop.index * 0.1 }}s both;">
            <a href="/point/{{ point.id }}" class="block h-full">
              <!-- Point Image -->
              <div class="relative overflow-hidden rounded-t-2xl">
                <img src="{{ point.point_image }}" 
                     alt="{{ point.title }}" 
                     class="w-full h-48 sm:h-52 object-cover enhanced-image group-hover:scale-110 transition-transform duration-700">
                
                <!-- Gradient Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                
                <!-- Quick Preview Button -->
                <div class="absolute top-3 right-3 transform translate-x-8 group-hover:translate-x-0 transition-transform duration-300">
                  <div class="w-10 h-10 bg-black/50 backdrop-blur-sm rounded-full flex items-center justify-center">
                    <i class="fas fa-eye text-white text-sm"></i>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="absolute bottom-4 left-4 right-4 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 opacity-0 group-hover:opacity-100">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-white bg-black/50 backdrop-blur-sm rounded-lg py-2 px-3">
                      <i class="fas fa-play text-xs"></i>
                      <span class="font-semibold text-sm">詳細を確認</span>
                    </div>
                    <div class="flex gap-2">
                      <button class="w-8 h-8 bg-red-500/80 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-red-500 transition-colors" onclick="event.preventDefault(); likePoint({{ point.id }})">
                        <i class="fas fa-heart text-white text-xs"></i>
                      </button>
                      <button class="w-8 h-8 bg-blue-500/80 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-blue-500 transition-colors" onclick="event.preventDefault(); bookmarkPoint({{ point.id }})">
                        <i class="fas fa-bookmark text-white text-xs"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Point Info -->
              <div class="p-5 bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-b-2xl flex-1 flex flex-col">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="text-xl font-bold text-white group-hover:text-red-400 transition-colors duration-300 line-clamp-2">
                    {{ point.title }}
                  </h3>
                  <div class="flex items-center gap-1 text-xs text-gray-400 ml-2">
                    <i class="fas fa-clock"></i>
                    <span>新着</span>
                  </div>
                </div>
                
                <p class="text-gray-300 text-sm mb-4 flex-1 group-hover:text-gray-200 transition-colors duration-300 line-clamp-3">
                  {{ point.description }}
                </p>

                <!-- Tags and Stats -->
                <div class="flex items-center justify-between text-xs">
                  <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-red-500/20 text-red-300 rounded-full">
                      {{ (side | title) if side else 'Attack' }}
                    </span>
                    <span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded-full">
                      {{ (map_id | title) if map_id else 'Map' }}
                    </span>
                  </div>
                  <div class="flex items-center gap-3 text-gray-400">
                    <div class="flex items-center gap-1">
                      <i class="fas fa-heart"></i>
                      <span>{{ point.likes_count or 0 }}</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <i class="fas fa-eye"></i>
                      <span>{{ loop.index * 23 }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selection Indicator -->
              <div class="absolute inset-0 border-2 border-transparent group-hover:border-red-500 rounded-2xl transition-colors duration-300 pointer-events-none"></div>
            </a>

            <!-- Delete Button (Admin Only) -->
            {% if True %}  <!-- Replace with admin check -->
            <button onclick="deletePoint({{ point.id }})" 
                    class="absolute top-3 left-3 w-8 h-8 bg-red-500/0 hover:bg-red-500/90 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 z-10"
                    title="削除">
              <i class="fas fa-trash text-white text-xs"></i>
            </button>
            {% endif %}
          </article>
        {% endfor %}
      </div>

      <!-- Load More Button (Placeholder) -->
      <div class="text-center mt-12">
        <button class="btn-primary inline-flex items-center gap-2 opacity-50 cursor-not-allowed">
          <i class="fas fa-plus"></i>
          <span>さらに読み込む</span>
        </button>
        <p class="text-gray-400 text-sm mt-2">すべての定点を表示中</p>
      </div>
    
    {% else %}
      <!-- Empty State -->
      <div class="glass rounded-2xl p-12 text-center max-w-md mx-auto">
        <div class="w-20 h-20 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-crosshairs text-3xl text-gray-400"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-3">定点が見つかりません</h3>
        <p class="text-gray-300 mb-6">選択したエージェントの定点はまだ登録されていません</p>
        <a href="/add" class="btn-primary inline-flex items-center gap-2">
          <i class="fas fa-plus"></i>
          <span>最初の定点を追加</span>
        </a>
      </div>
    {% endif %}
  </main>

  <!-- Enhanced FAB -->
  <a href="/add" class="fab group" title="新しい定点を追加">
    <i class="fas fa-plus transition-transform duration-300 group-hover:rotate-90"></i>
  </a>

  <!-- Floating Filter Button -->
  <button onclick="toggleFilters()" class="fixed bottom-24 right-6 w-12 h-12 bg-blue-500 hover:bg-blue-600 rounded-full shadow-lg flex items-center justify-center text-white transition-all duration-300 z-40">
    <i class="fas fa-filter"></i>
  </button>

  <!-- Filter Panel (Hidden by default) -->
  <div id="filterPanel" class="fixed inset-x-4 bottom-4 glass rounded-2xl p-6 transform translate-y-full transition-transform duration-300 z-30">
    <h4 class="font-bold text-white mb-4">フィルター</h4>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-2">並び順</label>
        <select class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm">
          <option>新着順</option>
          <option>人気順</option>
          <option>名前順</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">タイプ</label>
        <select class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm">
          <option>すべて</option>
          <option>リコン</option>
          <option>グレネード</option>
          <option>ショックダーツ</option>
        </select>
      </div>
    </div>
    <div class="flex justify-end mt-4">
      <button onclick="toggleFilters()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
        閉じる
      </button>
    </div>
  </div>

  <script>
    // Immediately clear any existing loading overlays
    (function() {
      const existingOverlays = document.querySelectorAll('.loading-overlay');
      existingOverlays.forEach(overlay => overlay.remove());
    })();
    
    // Global loading management
    let isNavigating = false;
    
    // Function to clear all loading overlays
    function clearLoadingOverlays() {
      const loadingOverlays = document.querySelectorAll('.loading-overlay');
      loadingOverlays.forEach(overlay => {
        if (overlay && overlay.parentElement) {
          overlay.remove();
        }
      });
      isNavigating = false;
    }
    
    // Clear loading overlays when page loads
    window.addEventListener('pageshow', function(event) {
      // Only clear if this is a back/forward navigation
      if (event.persisted) {
        setTimeout(clearLoadingOverlays, 100);
      }
    });
    
    // Handle browser back button specifically
    window.addEventListener('popstate', function(event) {
      setTimeout(clearLoadingOverlays, 200);
    });

    // Enhanced interactions
    document.addEventListener('DOMContentLoaded', function() {
      // Clear any lingering overlays and reset navigation state
      setTimeout(() => {
        clearLoadingOverlays();
        isNavigating = false;
      }, 50);
      const cards = document.querySelectorAll('.card');
      
      cards.forEach((card, index) => {
        card.addEventListener('mouseenter', function() {
          if (navigator.vibrate) {
            navigator.vibrate(10);
          }
          this.style.boxShadow = '0 25px 50px rgba(255, 70, 85, 0.25)';
        });

        card.addEventListener('mouseleave', function() {
          this.style.boxShadow = '';
        });

        card.addEventListener('click', function(e) {
          // ボタンクリックの場合は何もしない
          if (e.target.closest('button')) {
            return;
          }
          
          // 連打防止
          if (isNavigating) {
            return;
          }
          
          const link = this.querySelector('a');
          const url = link ? link.href : null;
          
          if (url) {
            isNavigating = true;
            
            if (navigator.vibrate) {
              navigator.vibrate(30);
            }
            
            // シンプルなローディング表示
            const loading = document.createElement('div');
            loading.className = 'loading-overlay absolute inset-0 bg-black/70 flex items-center justify-center rounded-2xl z-20';
            loading.innerHTML = `
              <div class="text-center">
                <div class="loading w-8 h-8 border-4 border-red-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                <p class="text-white text-sm">読み込み中...</p>
              </div>
            `;
            this.appendChild(loading);
            
            // 直接ページ遷移（短い遅延で確実に遷移）
            setTimeout(() => {
              try {
                window.location.href = url;
              } catch (error) {
                console.error('Navigation error:', error);
                // エラーの場合はローディングを削除
                if (loading.parentElement) {
                  loading.remove();
                }
                isNavigating = false;
              }
            }, 150);
            
            // フェイルセーフ: 2秒後にローディングを削除
            setTimeout(() => {
              if (loading.parentElement) {
                loading.remove();
                isNavigating = false;
              }
            }, 2000);
            
          }
        });
      });
      
      // Remove this interval check as it was too aggressive

      // Parallax effect
      document.addEventListener('mousemove', function(e) {
        const particles = document.querySelectorAll('.particle');
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;

        particles.forEach((particle, index) => {
          const speed = (index + 1) * 0.3;
          const x = mouseX * speed * 12;
          const y = mouseY * speed * 12;
          particle.style.transform = `translateX(${x}px) translateY(${y}px)`;
        });
      });
    });

    // Point interactions
    function likePoint(pointId) {
      console.log('Liked point:', pointId);
      // Add like functionality here
      if (navigator.vibrate) {
        navigator.vibrate([50, 100, 50]);
      }
    }

    function bookmarkPoint(pointId) {
      console.log('Bookmarked point:', pointId);
      // Add bookmark functionality here
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    function deletePoint(pointId) {
      if (confirm('この定点を削除しますか？')) {
        fetch(`/delete/${pointId}`, { method: 'POST' })
          .then(() => location.reload())
          .catch(err => console.error('Delete failed:', err));
      }
    }

    // Filter panel
    function toggleFilters() {
      const panel = document.getElementById('filterPanel');
      const isVisible = !panel.classList.contains('translate-y-full');
      
      if (isVisible) {
        panel.classList.add('translate-y-full');
      } else {
        panel.classList.remove('translate-y-full');
      }
    }

    // Close filter panel when clicking outside
    document.addEventListener('click', function(e) {
      const panel = document.getElementById('filterPanel');
      const filterBtn = document.querySelector('[onclick="toggleFilters()"]');
      
      if (!panel.contains(e.target) && !filterBtn.contains(e.target)) {
        panel.classList.add('translate-y-full');
      }
    });
  </script>
</body>
</html>
